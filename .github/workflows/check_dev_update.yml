name: Check Dev Release

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight
  workflow_dispatch: # Allows manual triggering

jobs:
  check-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Check latest release version from Anaconda
        id: check_anaconda
        run: |
          # Variables
          ANACONDA_API_URL="https://api.anaconda.org/package/bsteubing/activity-browser-dev"
          LABEL="main"
          
          # Fetch the package information from Anaconda
          PACKAGE_INFO=$(curl -s $ANACONDA_API_URL)

          # Extract the latest version for the specified label
          LATEST_VERSION=$(echo $PACKAGE_INFO | jq -r --arg LABEL "$LABEL" '.files[] | select(.labels[] == $LABEL) | .version' | sort -V | tail -n 1)
          
          # Read the local version from version.json
          LOCAL_VERSION=$(jq -r .dev ab_releases/current.json)
          
          # Compare versions and update if necessary
          if [ "$LATEST_VERSION" != "$LOCAL_VERSION" ]; then
            echo "New version found: $LATEST_VERSION"
            echo "::set-output name=new_version::true"
          else
            echo "No new version found"
            echo "::set-output name=new_version::false"
          fi

      - name: Perform action if new version is found
        if: steps.check_anaconda.outputs.new_version == 'true'
        run: |
          echo "New version found, performing actions..."
          # Add your actions here, for example:
          # - Send a notification
          # - Create an issue
          # - Trigger another workflow